<?php 	//********************	//** WEB MIRACLE TECHNOLOGIES	//********************		// get post	$event_type = (isset($_POST['type']) && $_POST['type'] ? $_POST['type'] : 0);	if ($event_type == 0) exit("Internal error. Please contact to developer.");		$appTable = $_POST['appTable'];	$item_id = $_POST['item_id'];	switch ($event_type) {		case '3':			$cardUpd = flatLayoutEvent();			break;			case '4':			$cardUpd = cottageLayoutEvent();			break;		case '5':			$cardUpd = townhousesTimerLayoutEvent();			break;		case '6':			$cardUpd = townhousesBlockEvent();			break;		case '2':			$cardUpd = flatsRoomEvent();			break;			case '1':			$cardUpd = bodyBannerEvent();			break;			case '7':		case '8':			$cardUpd = flatCarSaleEvent();			$ev_alias = ($event_type == 8 ? 'car' : ($event_type == 7 ? 'flat' : '')); 			$ev_meta_title = $_POST['meta_title'];			$ev_meta_desc = $_POST['meta_desc'];			$ev_meta_keys = $_POST['meta_keys'];			$event_meta_query = "				UPDATE `osc_meta_table` 				SET 					`meta_title` = '$ev_meta_title',					`meta_desc` = '$ev_meta_desc',					`meta_keys` = '$ev_meta_keys'				WHERE `alias` = '$ev_alias'				LIMIT 1			";			break;			case '9':			$cardUpd = newEv();			break;			default:			break;	}		function flatLayoutEvent(){		return array(			'type'			=> $_POST['type'],			'name'			=> $_POST['name'],			'block'			=> $_POST['block'][0],			'timer_date'	=> $_POST['timer_date']		);	}	function cottageLayoutEvent(){		return array(			'type'			=> $_POST['type'],			'name'			=> $_POST['name'],			'block'			=> $_POST['block'][0],			'details'		=> $_POST['details']		);	}	function townhousesTimerLayoutEvent(){		return array(			'type'			=> $_POST['type'],			'name'			=> $_POST['name'],			'old_price'		=> (double)$_POST['old_price'],			'curr_price'	=> (double)$_POST['curr_price'],			'block'			=> $_POST['block'][0],			'timer_date'	=> $_POST['timer_date'],			'details'		=> $_POST['details']		);	}	function townhousesBlockEvent(){		return array(			'type'			=> $_POST['type'],			'name'			=> $_POST['name'],			'caption'		=> $_POST['caption'],			'details'		=> $_POST['details'],			'old_price'		=> (double)$_POST['old_price'],			'curr_price'	=> (double)$_POST['curr_price'],			'block'			=> $_POST['block'][0],			'benefits'		=> (mb_strlen($_POST['benefits']) > 0 ? serialize($_POST['benefits']) : '')		);	}	function flatsRoomEvent(){		return array(			'type'			=> $_POST['type'],			'name'			=> $_POST['name'],			'block'			=> $_POST['block'][0]		);	}	function bodyBannerEvent(){		return array(			'type'			=> $_POST['type'],			'name'			=> $_POST['name'],			'block'			=> $_POST['block'][0]		);	}	function newEv(){		return array(			'type'			=> $_POST['type'],			'caption'		=> $_POST['caption'],			'block'			=> $_POST['block'][0]		);	}	function flatCarSaleEvent(){		return array(			'type'			=> $_POST['type'],			'name'			=> $_POST['name'],			'block'			=> $_POST['block'][0],			'caption'		=> $_POST['caption'],			'details'			=> $_POST['details'],		);	}	$file_path = "../../../../split/files/events/";	$im_1_filename = "room_banner";	$im_1 		= false;	$im_1_name 	= 5;	$im_1_pre 	= "ev_";		if(isset($_FILES[$im_1_filename]) && $_FILES[$im_1_filename]['size'] > 0){		$im_1 = true;	}	if($im_1){		$file_update = false;		$file_update = $ah->mtvc_add_files_file(array(				'path'			=>$file_path,				'name'			=>$im_1_name,				'pre'			=>$im_1_pre,				'size'			=>10,				'rule'			=>0,				'max_w'			=>2500,				'max_h'			=>2500,				'files'			=>$im_1_filename			  ));		if($file_update){			$cardUpd[$im_1_filename] = $file_update;		}	}	$im_2_filename = "body_banner_left";	$im_2 		= false;	$im_2_name 	= 5;	$im_2_pre 	= "ev_";		if(isset($_FILES[$im_2_filename]) && $_FILES[$im_2_filename]['size'] > 0){		$im_2 = true;	}	if($im_2){		$file_update = false;		$file_update = $ah->mtvc_add_files_file(array(				'path'			=>$file_path,				'name'			=>$im_2_name,				'pre'			=>$im_2_pre,				'size'			=>10,				'rule'			=>0,				'max_w'			=>2500,				'max_h'			=>2500,				'files'			=>$im_2_filename			  ));		if($file_update){			$cardUpd[$im_2_filename] = $file_update;		}	}	$im_3_filename = "body_banner_right";	$im_3 		= false;	$im_3_name 	= 5;	$im_3_pre 	= "ev_";		if(isset($_FILES[$im_3_filename]) && $_FILES[$im_3_filename]['size'] > 0){		$im_3 = true;	}	if($im_3){		$file_update = false;		$file_update = $ah->mtvc_add_files_file(array(				'path'			=>$file_path,				'name'			=>$im_3_name,				'pre'			=>$im_3_pre,				'size'			=>10,				'rule'			=>0,				'max_w'			=>2500,				'max_h'			=>2500,				'files'			=>$im_3_filename			  ));		if($file_update){			$cardUpd[$im_3_filename] = $file_update;		}	}	// Update main table	$query = "UPDATE [pre]$appTable SET ";	$cntUpd = 0;	foreach($cardUpd as $field => $itemUpd){		$cntUpd++;		$query .= ($cntUpd==1 ? "`$field`='$itemUpd'" : ", `$field`='$itemUpd'");	}	$query .= " WHERE `id`=$item_id LIMIT 1";	$ah->rs($query);	$layouts_id = (isset($_POST['layout_id']) && $_POST['layout_id'] ? $_POST['layout_id'] : array());	$layout_table = "";	switch ($event_type) {		case '3':			$layout_table = "osc_sys_flats_area";			break;			case '4':			$layout_table = "osc_sys_cottages_layouts";			break;		case '5':			$layout_table = "osc_sys_townhouses_layouts";			break;		case '6':			$layout_table = "osc_sys_townhouses";			break;		case '2':			$layout_table = "osc_sys_flats_rooms";			break;			default:			break;	}	if ($layouts_id) {		foreach ($layouts_id as $key => $value) {			$q = "UPDATE `".$layout_table."` SET `event_id` = '$item_id' WHERE `id` = '$value'";			$ah->rs($q,0,1);		}	}	////////////////////////////////////////////////////	$ex_layouts_id = (isset($_POST['ex_layout_id']) && $_POST['ex_layout_id'] ? $_POST['ex_layout_id'] : array());	$ex_layout_table = "";	switch ($event_type) {		case '3':			$ex_layout_table = "osc_sys_flats_area";			break;			case '4':			$ex_layout_table = "osc_sys_cottages_layouts";			break;		case '5':			$ex_layout_table = "osc_sys_townhouses_layouts";			break;		case '6':			$ex_layout_table = "osc_sys_townhouses";			break;		case '2':			$ex_layout_table = "osc_sys_flats_rooms";			break;			default:			break;	}	if ($ex_layouts_id) {		foreach ($ex_layouts_id as $key => $value) {			$q = "UPDATE `".$ex_layout_table."` SET `event_id` = 0 WHERE `id` = '$value'";			$ah->rs($q,0,1);		}	}	if (isset($event_meta_query) && $event_meta_query) {		$ah->rs($event_meta_query,0,1);	}	/*IMG GALLERY SET*/	$file_path = "../../../../split/files/events/";	$filename = "items";	if(isset($_FILES[$filename]) && count($_FILES[$filename]) > 0 && $item_id){				$files_upload = $ah->mtvc_add_files_file_miltiple(array(				'path'			=>$file_path,				'name'			=>5,				'pre'			=>"evi_",				'size'			=>10,				'rule'			=>0,				'max_w'			=>2500,				'max_h'			=>2500,				'files'			=>$filename,				'resize_path'	=>$file_path			  ));		if($files_upload){			foreach($files_upload as $file_upload){				$query = "INSERT INTO osc_sys_event_items (`ref`, `file`) VALUES ('$item_id', '$file_upload')";								$ah->rs($query,0,1);				chmod($file_path.$file_upload,0777);			}		}	}		$data['message'] = "Новость #$item_id успешно сохранен.";	